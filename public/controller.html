<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TT CONTROL PRO</title>

  <style>
    body{
      margin:0;
      background:#11151c;
      font-family:-apple-system,system-ui;
      color:white;
    }

    .wrapper{
      max-width:650px;
      margin:auto;
      padding:18px;
    }

    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:15px;
    }

    .tab{
      flex:1;
      padding:12px;
      background:#1e2530;
      text-align:center;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }

    .tab.active{ background:#0007f8; }

    .page{display:none;}
    .page.active{display:block;}

    .scoreGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:15px;
      margin-bottom:15px;
    }

    .card{
      background:#1e2530;
      padding:20px;
      border-radius:18px;
      text-align:center;
      transition:.2s;
    }

    .card.flash{
      animation:flash .25s ease;
    }

    @keyframes flash{
      50%{transform:scale(1.08);}
    }

    .name{
      font-weight:800;
      margin-bottom:8px;
    }

    .points{
      font-size:42px;
      font-weight:900;
    }

    button{
      border:none;
      border-radius:16px;
      font-size:20px;
      padding:16px;
      margin:6px 0;
      width:100%;
      font-weight:900;
      cursor:pointer;
      transition:.2s;
    }

    button:active{transform:scale(.95);}

    .startBtn{ background:#00c853; }
    .btnA{ background: #0070ff; }
    .btnB{ background:#9b00c5; }
    .timeout{ background:#ff9800; }
    .endTimeout{ background:#ffc107;color:#111; }
    .small{ font-size:15px;padding:12px; }
    .danger{ background:#b00020; }

    input,select{
      width:100%;
      padding:10px;
      margin:8px 0;
      border-radius:10px;
      border:none;
      background:#1e2530;
      color:white;
    }

    .badge{
      background:#2e7d32;
      font-size:12px;
      padding:4px 8px;
      border-radius:8px;
      margin-left:6px;
    }
  </style>
</head>
<body>

<div class="wrapper">

  <div class="tabs">
    <div class="tab active" onclick="switchPage('match',event)">Match</div>
    <div class="tab" onclick="switchPage('settings',event)">Paramètres</div>
  </div>

  <!-- MATCH -->
  <div id="match" class="page active">

    <div class="scoreGrid">
      <div class="card" id="cardA">
        <div class="name" id="nameA">JOUEUR A</div>
        <div class="points" id="scoreA">0</div>
      </div>

      <div class="card" id="cardB">
        <div class="name" id="nameB">JOUEUR B</div>
        <div class="points" id="scoreB">0</div>
      </div>
    </div>

    <button class="startBtn" id="startBtn">Démarrer</button>

    <button class="btnA" id="btnA" disabled></button>
    <button class="btnB" id="btnB" disabled></button>

    <button class="timeout" id="toA">Temps mort A</button>
    <button class="timeout" id="toB">Temps mort B</button>

    <button class="endTimeout" id="endTimeout" style="display:none;">
      Fin du temps mort
    </button>

    <button class="small" onclick="safeSend('UNDO')">Annuler</button>
    <button class="small danger" onclick="safeSend('RESET_MATCH')">Reset Match</button>

  </div>

  <!-- SETTINGS -->
  <div id="settings" class="page">

    <label>Mode</label>
    <select id="mode">
      <option value="singles">Simple</option>
      <option value="doubles">Double</option>
    </select>

    <label>A1</label>
    <input id="A1">

    <label>A2</label>
    <input id="A2">

    <label>B1</label>
    <input id="B1">

    <label>B2</label>
    <input id="B2">

    <label>Format</label>
    <select id="bestOf">
      <option value="3">BO3</option>
      <option value="5">BO5</option>
    </select>

    <button class="btnA" onclick="applySettings()">Appliquer</button>

  </div>

</div>

<script>
  const TOKEN="moncode123";

  const socket=new WebSocket(
          (location.protocol==="https:"?"wss://":"ws://")
          +location.host+"?token="+TOKEN
  );

  const el=id=>document.getElementById(id);
  let lastState=null;

  /* =====================
     UTIL
  ===================== */

  function safeSend(type,data={}){
    if(socket.readyState!==1){
      alert("Connexion perdue");
      return;
    }
    socket.send(JSON.stringify({type,...data}));
  }

  function flash(team){
    const card = team==="A"?el("cardA"):el("cardB");
    card.classList.add("flash");
    setTimeout(()=>card.classList.remove("flash"),250);
  }

  function teamName(st,team){
    if(team==="A"){
      return st.mode==="doubles" && st.A2
              ? st.A1+" / "+st.A2
              : st.A1;
    }else{
      return st.mode==="doubles" && st.B2
              ? st.B1+" / "+st.B2
              : st.B1;
    }
  }

  /* =====================
     START MATCH
  ===================== */

  el("startBtn").onclick=()=>{

    if(!lastState) return;

    const nameA = teamName(lastState,"A");
    const nameB = teamName(lastState,"B");

    const choice = prompt(
            "Qui sert en premier ?\n\n1 = "+nameA+
            "\n2 = "+nameB
    );

    if(choice==="1"){
      safeSend("START_MATCH",{firstServer:"A"});
    }

    if(choice==="2"){
      safeSend("START_MATCH",{firstServer:"B"});
    }
  };

  /* =====================
     SETTINGS
  ===================== */

  function applySettings(){
    safeSend("UPDATE_SETTINGS",{
      mode:el("mode").value,
      A1:el("A1").value,
      A2:el("A2").value,
      B1:el("B1").value,
      B2:el("B2").value,
      bestOf:parseInt(el("bestOf").value)
    });
  }

  /* =====================
     SOCKET
  ===================== */

  socket.onmessage=(e)=>{
    const st=JSON.parse(e.data);
    lastState=st;

    const nameA=teamName(st,"A");
    const nameB=teamName(st,"B");

    el("nameA").textContent=nameA;
    el("nameB").textContent=nameB;

    el("scoreA").textContent=st.pointsA;
    el("scoreB").textContent=st.pointsB;

    el("btnA").textContent="+1 "+nameA;
    el("btnB").textContent="+1 "+nameB;

    // Active +1 seulement si matchStarted
    el("btnA").disabled=!st.matchStarted || st.timeoutActive;
    el("btnB").disabled=!st.matchStarted || st.timeoutActive;

    el("btnA").onclick=()=>{
      safeSend("POINT_A");
      flash("A");
    };

    el("btnB").onclick=()=>{
      safeSend("POINT_B");
      flash("B");
    };

    el("toA").onclick=()=>safeSend("TIMEOUT_A");
    el("toB").onclick=()=>safeSend("TIMEOUT_B");
    el("endTimeout").onclick=()=>safeSend("END_TIMEOUT");

    el("toA").disabled=st.timeoutUsedA || !st.matchStarted;
    el("toB").disabled=st.timeoutUsedB || !st.matchStarted;

    el("endTimeout").style.display=st.timeoutActive?"block":"none";

    el("startBtn").style.display=st.matchStarted?"none":"block";

    // sync settings
    el("mode").value=st.mode;
    el("A1").value=st.A1;
    el("A2").value=st.A2;
    el("B1").value=st.B1;
    el("B2").value=st.B2;
    el("bestOf").value=st.bestOf;
  };

  function switchPage(page,e){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    el(page).classList.add("active");
    e.target.classList.add("active");
  }
</script>

</body>
</html>